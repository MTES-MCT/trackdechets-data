{{
  config(
    materialized = 'incremental',
    incremental_strategy = 'delete+insert',
    unique_key = ['id'],
    on_schema_change='append_new_columns'
    )
}}

with source as (
    select *
    from {{ ref('registry_outgoing_waste') }}
    where is_latest and not is_cancelled
)

select
        id,
        created_at,
        updated_at,
        import_id,
        is_latest,
        is_cancelled,
        created_by_id,
        public_id,
        report_for_company_siret,
        report_for_company_name,
        report_for_company_address,
        report_for_company_city,
        report_for_company_postal_code,
        report_for_pickup_site_name,
        report_for_pickup_site_address,
        report_for_pickup_site_postal_code,
        report_for_pickup_site_city,
        report_for_pickup_site_country_code,
        report_as_company_siret,
        waste_description,
        waste_code,
        waste_code_bale,
        waste_pop,
        waste_is_dangerous,
        dispatch_date,
        weight_value,
        weight_is_estimate,
        volume,
        initial_emitter_company_type,
        initial_emitter_company_org_id,
        initial_emitter_company_name,
        initial_emitter_company_address,
        initial_emitter_company_postal_code,
        initial_emitter_company_city,
        initial_emitter_company_country_code,
        initial_emitter_municipalities_insee_codes,
        destination_company_type,
        destination_company_org_id,
        destination_company_name,
        destination_company_address,
        destination_company_city,
        destination_company_postal_code,
        destination_company_country_code,
        destination_drop_site_address,
        destination_drop_site_postal_code,
        destination_drop_site_city,
        destination_drop_site_country_code,
        movement_number,
        operation_code,
        operation_mode,
        eco_organisme_siret,
        eco_organisme_name,
        broker_company_siret,
        broker_company_name,
        broker_recepisse_number,
        trader_company_siret,
        trader_company_name,
        trader_recepisse_number,
        is_direct_supply,
        transporter1_transport_mode,
        transporter1_company_type,
        transporter1_company_org_id,
        transporter1_recepisse_is_exempted,
        transporter1_recepisse_number,
        transporter1_company_name,
        transporter1_company_address,
        transporter1_company_postal_code,
        transporter1_company_city,
        transporter1_company_country_code,
        transporter2_transport_mode,
        transporter2_company_type,
        transporter2_company_org_id,
        transporter2_recepisse_is_exempted,
        transporter2_recepisse_number,
        transporter2_company_name,
        transporter2_company_address,
        transporter2_company_postal_code,
        transporter2_company_city,
        transporter2_company_country_code,
        transporter3_transport_mode,
        transporter3_company_type,
        transporter3_company_org_id,
        transporter3_recepisse_is_exempted,
        transporter3_recepisse_number,
        transporter3_company_name,
        transporter3_company_address,
        transporter3_company_postal_code,
        transporter3_company_city,
        transporter3_company_country_code,
        transporter4_transport_mode,
        transporter4_company_type,
        transporter4_company_org_id,
        transporter4_recepisse_is_exempted,
        transporter4_recepisse_number,
        transporter4_company_name,
        transporter4_company_address,
        transporter4_company_postal_code,
        transporter4_company_city,
        transporter4_company_country_code,
        transporter5_transport_mode,
        transporter5_company_type,
        transporter5_company_org_id,
        transporter5_recepisse_is_exempted,
        transporter5_recepisse_number,
        transporter5_company_name,
        transporter5_company_address,
        transporter5_company_postal_code,
        transporter5_company_city,
        transporter5_company_country_code,
        gistrid_number,
        transporters_org_ids
    from source
